services:
  php-apache84:
    image: php8.4-apache-horde:latest
    build: ./images/php8.4-apache-horde/
    ports:
      - 127.0.0.1:5080:80
    volumes:
      - ./git-tree:/srv/git
      - ./install-tree:/var/www/horde-dev
      - ./tools:/usr/local/tools
    env_file:
      - path: ./dev-setup.dist.env
        required: "true"
      - path: ./dev-setup.local.env
        required: "false"
    environment:
      - GITHUB_TOKEN
    container_name: horde_apache
  horde_db:
    image: mariadb
    restart: always
    container_name: horde_db
    env_file:
      - path: ./dev-setup.dist.env
        required: "true"
      - path: ./dev-setup.local.env
        required: "false"
    volumes:
      - ./mariadb-seed:/docker-entrypoint-initdb.d
      - ./mariadb-data:/var/lib/mysql
  horde_ldap:
    container_name: horde_ldap
    image: osixia/openldap
    ports:
      - 127.0.0.1:389:389
    volumes:
      - ./ldap-data:/var/lib/ldap
      - ./ldap-config:/etc/ldap/slapd.d/
     # - ./ldap-seed:/container/service/slapd/assets/config/bootstrap/ldif/custom
     ## Mounting the seed dir currently breaks stuff

    env_file:
      - path: ./dev-setup.dist.env
        required: "true"
      - path: ./dev-setup.local.env
        required: "false"
      #LDAP_ORGANISATION: "horde.org"
      #LDAP_DOMAIN: "demo.horde.org"
      #LDAP_ADMIN_PASSWORD: horde
  ldap_admin:
    container_name: ldap_admin
    image: osixia/phpldapadmin
    ports:
    ## TODO: Bind to localhost and serve through https reverse proxy
      - 127.0.0.1:6080:80
    env_file: 
      - path: ./dev-setup.dist.env
        required: "true"
      - path: ./dev-setup.local.env
        required: "false"

## Imported from maintaina/containers

#  dovecot:
#    hostname: ${DOVECOT_HOSTNAME}
#    image: ghcr.io/maintaina/containers/dovecot-horde:latest
#    container_name: ${CONTAINER_PREFIX}horde_dovecot
#    environment:
#      - MYSQL_USER=${MARIADB_HORDE_USER}
#      - MYSQL_PASSWORD=${MARIADB_HORDE_USER_PASSWORD}
#      - MYSQL_DATABASE=${MARIADB_HORDE_DB}
#      - MYSQL_HOSTNAME=${MARIADB_HOSTNAME}
#      - EXPAND_CONFIGS=${EXPAND_CONFIGS}
    ## Use a config volume to provide a completely different config and certs
    # volumes:
    #   - ./dovecot/dovecot.conf:/etc/dovecot/dovecot.conf
    #   - ./dovecot/dovecot-sql.conf.ext:/etc/dovecot/dovecot-sql.conf.ext
#    networks:
#      - hordenet
#    entrypoint: ["/usr/bin/tini", "--", "/usr/local/bin/entrypoint.sh"]
#    command: ["/usr/sbin/dovecot", "-F"]
## Uncomment to expose imap port to all host interfaces
#    ports:
#    - "143:143"

 # postfix:
#    hostname: ${POSTFIX_HOSTNAME}
#    image: ghcr.io/maintaina/containers/postfix-horde:latest
#    container_name: ${CONTAINER_PREFIX}horde_postfix
#    environment:
#      - MYSQL_USER=${MARIADB_HORDE_USER}
#      - MYSQL_PASSWORD=${MARIADB_HORDE_USER_PASSWORD}
#      - MYSQL_DATABASE=${MARIADB_HORDE_DB}
#      - MYSQL_HOSTNAME=${MARIADB_HOSTNAME}
#      - EXPAND_CONFIGS=${EXPAND_CONFIGS}
#      - HORDE_DOMAIN=${HORDE_DOMAIN}
#      - CONTAINER_PREFIX=${CONTAINER_PREFIX}
#    # volumes:
#    #   - ./postfix/mysql_virtual_mailbox_domains.cf:/etc/postfix/mysql_virtual_mailbox_domains.cf
    #   - ./postfix/mysql_virtual_mailbox_maps.cf:/etc/postfix/mysql_virtual_mailbox_maps.cf
#    networks:
#      - hordenet
